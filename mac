#!/bin/sh

# Laptop setup script
# Be prepared to turn your laptop (or desktop, no haters here)
# into an awesome development machine.

# Manual Steps
# ============
# * Setup 1password

fancy_echo() {
  local fmt="$1"; shift

  # shellcheck disable=SC2059
  printf "\n$fmt\n" "$@"
}

if [ ! -d "$HOME/.bin/" ]; then
  mkdir "$HOME/.bin"
fi

# Determine Homebrew prefix based on architecture
ARCH="$(uname -m)"
if [ "$ARCH" = "arm64" ]; then
  HOMEBREW_PREFIX="/opt/homebrew"
else
  HOMEBREW_PREFIX="/usr/local"
fi

if ! command -v brew >/dev/null; then
  fancy_echo "Installing Homebrew ..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [ $? -ne 0 ]; then
    printf "Homebrew installation failed. Exiting.\n" >&2
    exit 1
  fi

  # Add Homebrew to PATH for this session
  eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
fi

fancy_echo "Updating Homebrew formulae ..."
brew update --force

# Allow brew bundle to report failures without aborting the script.
# Individual formula/cask failures are logged but won't prevent the
# rest of the setup from completing.
brew bundle --file=- <<EOF
tap "brimdata/tap"

# Unix
brew "git"
brew "git-lfs"
brew "openssl@3"
brew "rcm"
brew "tmux"
brew "tmuxinator"
brew "tpm"
brew "watchman"
brew "zsh"
brew "fish"

# GitHub
brew "gh"

# Image manipulation / processing
brew "imagemagick"
brew "vips"

# Programming language prerequisites and package managers
brew "asdf"
brew "yarn"

# Databases
brew "postgresql@17"
brew "redis"

# Cloud / infrastructure
brew "awscli"
brew "circleci"
brew "nomad"

# Dev tools
brew "chroma"
brew "cmake"
brew "cmake-docs"
brew "colordiff"
brew "direnv"
brew "ffmpeg@6"
brew "fswatch"
brew "fzf"
brew "jq"
brew "libxslt"
brew "llvm"
brew "miller"
brew "mkcert"
brew "neovim"
brew "pipx"
brew "ripgrep"
brew "tree"
brew "unixodbc"
brew "websocat"
brew "wget"
brew "wxwidgets"
brew "yt-dlp"
brew "brimdata/tap/zq"

# Fun
brew "cowsay"
brew "figlet"
brew "fortune"
brew "lolcat"

# Casks
cask "1password"
cask "altair-graphql-client"
cask "chromedriver"
cask "claude"
cask "docker-desktop"
cask "font-hack"
cask "font-jetbrains-mono"
cask "font-jetbrains-mono-nerd-font"
cask "font-menlo-for-powerline"
cask "font-sf-mono-for-powerline"
cask "gcloud-cli"
cask "ghostty"
cask "gpg-suite"
cask "insomnia"
cask "linear-linear"
cask "loom"
cask "macdown"
cask "muzzle"
cask "ngrok"
cask "notion"
cask "protonvpn"
cask "rectangle"
cask "session-manager-plugin"
cask "tuple"
cask "visual-studio-code"
EOF

if [ $? -ne 0 ]; then
  fancy_echo "Warning: Some formulae or casks failed to install. Check the output above."
  fancy_echo "Continuing with the rest of the setup..."
fi

# From here on, abort on errors â€” these steps depend on each other
set -e

# Set up git-lfs hooks
git lfs install

# Clone dotfiles and create symlinks
if [ ! -d "$HOME/.dotfiles" ]; then
  fancy_echo "Cloning dotfiles..."
  git clone https://github.com/samcdavid/dotfiles.git "$HOME/.dotfiles"
fi
fancy_echo "Setting up dotfiles symlinks..."
rcup -f

# Set fish as default shell
update_shell() {
  local shell_path;
  shell_path="$(which fish)"

  fancy_echo "Changing your shell to fish ..."
  if ! grep "$shell_path" /etc/shells > /dev/null 2>&1 ; then
    fancy_echo "Adding '$shell_path' to /etc/shells"
    sudo sh -c "echo $shell_path >> /etc/shells"
  fi
  chsh -s "$shell_path"
}

case "$SHELL" in
  */fish)
    fancy_echo "Already using fish shell."
    ;;
  *)
    update_shell
    ;;
esac

# Configure asdf version manager (installed via Homebrew)
fancy_echo "Configuring asdf version manager..."

install_asdf_plugin() {
  local name="$1"
  local url="$2"

  if ! asdf plugin list 2>/dev/null | grep -Fq "$name"; then
    asdf plugin add "$name" "$url"
  fi
}

# Source asdf for this session
# shellcheck disable=SC1091
. "$(brew --prefix asdf)/libexec/asdf.sh"

install_asdf_plugin "ruby" "https://github.com/asdf-vm/asdf-ruby"
install_asdf_plugin "nodejs" "https://github.com/asdf-vm/asdf-nodejs"
install_asdf_plugin "erlang" "https://github.com/asdf-vm/asdf-erlang"
install_asdf_plugin "elixir" "https://github.com/asdf-vm/asdf-elixir"
install_asdf_plugin "python" "https://github.com/asdf-vm/asdf-python"
install_asdf_plugin "golang" "https://github.com/asdf-vm/asdf-golang"
install_asdf_plugin "terraform" "https://github.com/asdf-community/asdf-hashicorp"

fancy_echo "Installing languages from ~/.tool-versions..."
(cd "$HOME" && asdf install)

if [ -f "$HOME/.laptop.local" ]; then
  fancy_echo "Running your customizations from ~/.laptop.local ..."
  # shellcheck disable=SC1090
  . "$HOME/.laptop.local"
fi

# Install Oh My Fish
if [ ! -d "$HOME/.local/share/omf" ]; then
  fancy_echo "Installing Oh My Fish..."
  curl -L https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install > /tmp/omf-install
  fish /tmp/omf-install --noninteractive
  rm /tmp/omf-install
fi

# Install Oh My Fish packages from bundle
fancy_echo "Installing Oh My Fish packages..."
fish -c "omf install"

# Install tmux plugins via TPM
fancy_echo "Installing tmux plugins..."
"$HOMEBREW_PREFIX/opt/tpm/share/tpm/bin/install_plugins"

# Authenticate with GitHub
if ! gh auth status >/dev/null 2>&1; then
  fancy_echo "Authenticating with GitHub..."
  fancy_echo "A browser window will open for you to sign in."
  if gh auth login --web --git-protocol https -h github.com; then
    fancy_echo "GitHub authentication successful."
  else
    fancy_echo "Warning: GitHub authentication failed or was skipped."
    fancy_echo "You can authenticate later with: gh auth login"
  fi
fi

# Generate GPG key for commit signing
GPG_EMAIL="sam@mcdavid.us"
if ! gpg --list-secret-keys "$GPG_EMAIL" >/dev/null 2>&1; then
  fancy_echo "Generating GPG key for commit signing..."
  fancy_echo "You will be prompted to set a passphrase for the key."
  if gpg --quick-generate-key "Sam McDavid <$GPG_EMAIL>" rsa4096 default 0; then
    fancy_echo "GPG key generated successfully."
  else
    fancy_echo "Warning: GPG key generation failed. Set up manually later."
  fi
fi

# Configure GPG signing in git and add key to GitHub
GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format long "$GPG_EMAIL" 2>/dev/null \
  | awk '/^sec/{print $2}' | cut -d'/' -f2 | head -1)

if [ -n "$GPG_KEY_ID" ]; then
  git config --global user.signingkey "$GPG_KEY_ID"
  git config --file "$HOME/.gitconfig-work" user.signingkey "$GPG_KEY_ID"
  git config --file "$HOME/.gitconfig-personal" user.signingkey "$GPG_KEY_ID"

  if gh auth status >/dev/null 2>&1; then
    if gpg --armor --export "$GPG_KEY_ID" | gh gpg-key add - 2>/dev/null; then
      fancy_echo "GPG key $GPG_KEY_ID added to GitHub."
    else
      fancy_echo "Warning: Could not add GPG key to GitHub (may already exist)."
    fi
  else
    fancy_echo "GPG key configured locally. Add to GitHub manually:"
    fancy_echo "  gpg --armor --export $GPG_KEY_ID | gh gpg-key add -"
  fi

  fancy_echo "GPG signing configured with key $GPG_KEY_ID"
else
  fancy_echo "Warning: No GPG key found. Commit signing will need manual setup."
fi
