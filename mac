#!/bin/sh

# Laptop setup script
# Be prepared to turn your laptop (or desktop, no haters here)
# into an awesome development machine.

# Manual Steps
# ============
# * Update keys in github
# * Update gpg signing key and auto signing
# * Clone dotfiles and setup with `rcup ~/.dotfiles`
# * Setup LazyVim (https://www.lazyvim.org/installation)
# * Setup 1password

fancy_echo() {
  local fmt="$1"; shift

  # shellcheck disable=SC2059
  printf "\n$fmt\n" "$@"
}

append_to_fish_config() {
  local text="$1"
  local fish_config="$HOME/.config/fish/config.fish"

  if [ ! -d "$HOME/.config/fish" ]; then
    mkdir -p "$HOME/.config/fish"
  fi

  if [ ! -f "$fish_config" ]; then
    touch "$fish_config"
  fi

  if ! grep -Fqs "$text" "$fish_config"; then
    printf "\n%s\n" "$text" >> "$fish_config"
  fi
}

if [ ! -d "$HOME/.bin/" ]; then
  mkdir "$HOME/.bin"
fi

# Determine Homebrew prefix based on architecture
ARCH="$(uname -m)"
if [ "$ARCH" = "arm64" ]; then
  HOMEBREW_PREFIX="/opt/homebrew"
else
  HOMEBREW_PREFIX="/usr/local"
fi

if ! command -v brew >/dev/null; then
  fancy_echo "Installing Homebrew ..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [ $? -ne 0 ]; then
    printf "Homebrew installation failed. Exiting.\n" >&2
    exit 1
  fi

  # Add Homebrew to PATH for this session
  eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
fi

fancy_echo "Updating Homebrew formulae ..."
brew update --force

# Allow brew bundle to report failures without aborting the script.
# Individual formula/cask failures are logged but won't prevent the
# rest of the setup from completing.
brew bundle --no-lock --file=- <<EOF
tap "homebrew/services"
tap "brimdata/tap"

# Unix
brew "git"
brew "git-lfs"
brew "openssl@3"
brew "rcm"
brew "tmux"
brew "tmuxinator"
brew "tpm"
brew "watchman"
brew "zsh"
brew "fish"

# GitHub
brew "gh"

# Image manipulation / processing
brew "imagemagick"
brew "vips"

# Programming language prerequisites and package managers
brew "asdf"
brew "yarn"

# Databases
brew "postgresql@17"
brew "redis"

# Cloud / infrastructure
brew "awscli"
brew "circleci"
brew "nomad"

# Dev tools
brew "chroma"
brew "cmake"
brew "cmake-docs"
brew "colordiff"
brew "direnv"
brew "ffmpeg@6"
brew "fswatch"
brew "fzf"
brew "jq"
brew "libxslt"
brew "llvm@11"
brew "miller"
brew "mkcert"
brew "neovim"
brew "pipx"
brew "ripgrep"
brew "tree"
brew "unixodbc"
brew "websocat"
brew "wget"
brew "wxwidgets"
brew "yt-dlp"
brew "brimdata/tap/zq"

# Fun
brew "cowsay"
brew "figlet"
brew "fortune"
brew "lolcat"

# Casks
cask "1password"
cask "altair-graphql-client"
cask "chromedriver"
cask "claude"
cask "docker-desktop"
cask "font-hack"
cask "font-jetbrains-mono"
cask "font-jetbrains-mono-nerd-font"
cask "font-menlo-for-powerline"
cask "font-sf-mono-for-powerline"
cask "gcloud-cli"
cask "ghostty"
cask "gpg-suite"
cask "insomnia"
cask "linear-linear"
cask "loom"
cask "macdown"
cask "muzzle"
cask "ngrok"
cask "notion"
cask "protonvpn"
cask "rectangle"
cask "session-manager-plugin"
cask "tuple"
cask "visual-studio-code"
EOF

if [ $? -ne 0 ]; then
  fancy_echo "Warning: Some formulae or casks failed to install. Check the output above."
  fancy_echo "Continuing with the rest of the setup..."
fi

# From here on, abort on errors â€” these steps depend on each other
set -e

# Set fish as default shell
update_shell() {
  local shell_path;
  shell_path="$(which fish)"

  fancy_echo "Changing your shell to fish ..."
  if ! grep "$shell_path" /etc/shells > /dev/null 2>&1 ; then
    fancy_echo "Adding '$shell_path' to /etc/shells"
    sudo sh -c "echo $shell_path >> /etc/shells"
  fi
  chsh -s "$shell_path"
}

case "$SHELL" in
  */fish)
    fancy_echo "Already using fish shell."
    ;;
  *)
    update_shell
    ;;
esac

# shellcheck disable=SC2016
append_to_fish_config 'fish_add_path $HOME/.bin'

# Configure asdf version manager (installed via Homebrew)
fancy_echo "Configuring asdf version manager..."
# shellcheck disable=SC2016
append_to_fish_config 'source (brew --prefix asdf)/libexec/asdf.fish'

install_asdf_plugin() {
  local name="$1"
  local url="$2"

  if ! asdf plugin list 2>/dev/null | grep -Fq "$name"; then
    asdf plugin add "$name" "$url"
  fi
}

# Source asdf for this session
# shellcheck disable=SC1091
. "$(brew --prefix asdf)/libexec/asdf.sh"

install_asdf_plugin "ruby" "https://github.com/asdf-vm/asdf-ruby"
install_asdf_plugin "nodejs" "https://github.com/asdf-vm/asdf-nodejs"
install_asdf_plugin "erlang" "https://github.com/asdf-vm/asdf-erlang"
install_asdf_plugin "elixir" "https://github.com/asdf-vm/asdf-elixir"
install_asdf_plugin "python" "https://github.com/asdf-vm/asdf-python"
install_asdf_plugin "golang" "https://github.com/asdf-vm/asdf-golang"
install_asdf_plugin "terraform" "https://github.com/asdf-community/asdf-hashicorp"

install_asdf_language() {
  local language="$1"
  local version
  version="$(asdf list all "$language" | grep -v '[a-zA-Z]' | tail -1)"

  if ! asdf list "$language" 2>/dev/null | grep -Fq "$version"; then
    asdf install "$language" "$version"
    asdf global "$language" "$version"
  fi
}

fancy_echo "Installing latest Node..."
install_asdf_language "nodejs"

if [ -f "$HOME/.laptop.local" ]; then
  fancy_echo "Running your customizations from ~/.laptop.local ..."
  # shellcheck disable=SC1090
  . "$HOME/.laptop.local"
fi

# Install Oh My Fish
if [ ! -d "$HOME/.local/share/omf" ]; then
  fancy_echo "Installing Oh My Fish..."
  curl -L https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install > /tmp/omf-install
  fish /tmp/omf-install --noninteractive
  rm /tmp/omf-install
fi
